{% extends "base.html" %}

{% block title %}ë°ì´í„° ê´€ë¦¬ - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ğŸ“Š ë°ì´í„° ê´€ë¦¬</h2>
    
    <!-- í˜„ì¬ ë°ì´í„°ë² ì´ìŠ¤ í˜„í™© -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">ğŸ‘¥ ì‚¬ìš©ì</h5>
                    <h3 class="text-primary">{{ users_count }}ëª…</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">ğŸ‘¶ ì•„ë™</h5>
                    <h3 class="text-success">{{ children_count }}ëª…</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">ğŸ“š í•™ìŠµ ê¸°ë¡</h5>
                    <h3 class="text-info">{{ records_count }}ê°œ</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">â­ í¬ì¸íŠ¸ ê¸°ë¡</h5>
                    <h3 class="text-warning">{{ points_count }}ê°œ</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ë°ì´í„° ê´€ë¦¬ ê¸°ëŠ¥ -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸŒ± ë°ì´í„° ì‹œë“œ</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        ìƒ˜í”Œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì—¬ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¶”ê°€ë¡œ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                    <form method="POST">
                        <input type="hidden" name="action" value="seed_data">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-seedling"></i> ì‹œë“œ ë°ì´í„° ì‹¤í–‰
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ’¾ ë°ì´í„° ë°±ì—…</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ JSON, Excel, DB íŒŒì¼ë¡œ ë°±ì—…í•©ë‹ˆë‹¤.
                        ê°œë°œìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    {% if current_user.role == 'ê°œë°œì' %}
                    <form method="POST" action="{{ url_for('backup_manual') }}" style="display: inline;">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-cloud-upload-alt"></i> ë°±ì—… ìƒì„±
                        </button>
                    </form>
                    <a href="#backup-list" class="btn btn-outline-info" data-bs-toggle="collapse">
                        <i class="fas fa-list"></i> ë°±ì—… ëª©ë¡
                    </a>
                    {% else %}
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-lock"></i> ê¶Œí•œ ì—†ìŒ
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ë°±ì—… ëª©ë¡ (collapse) -->
    {% if current_user.role == 'ê°œë°œì' %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="collapse" id="backup-list">
                <div class="card">
                    <div class="card-header">
                        <h5>ğŸ“‚ ë°±ì—… íŒŒì¼ ëª©ë¡</h5>
                    </div>
                    <div class="card-body">
                        <div id="backup-files-container">
                            <p class="text-muted">ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadBackupList()">
                            <i class="fas fa-refresh"></i> ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ìœ„í—˜í•œ ì‘ì—… -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5>âš ï¸ ìœ„í—˜í•œ ì‘ì—…</h5>
                </div>
                <div class="card-body">
                    <p class="card-text text-danger">
                        <strong>ì£¼ì˜:</strong> ì•„ë˜ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
                    </p>
                    
                    {% if current_user.role == 'ê°œë°œì' %}
                    <div class="alert alert-warning">
                        <h6>ğŸ”´ ë°ì´í„° ì´ˆê¸°í™”</h6>
                        <p>ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì²˜ìŒë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.</p>
                        <form method="POST" onsubmit="return confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')">
                            <input type="hidden" name="action" value="reset_data">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash"></i> ëª¨ë“  ë°ì´í„° ì‚­ì œ
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <p><i class="fas fa-lock"></i> ê°œë°œìë§Œ ë°ì´í„° ì´ˆê¸°í™”ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš© ê°€ì´ë“œ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“– ì‚¬ìš© ê°€ì´ë“œ</h5>
                </div>
                <div class="card-body">
                    <h6>ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬</h6>
                    <ul>
                        <li><code>flask db migrate -m "ì„¤ëª…"</code> - ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ ì¶”ì </li>
                        <li><code>flask db upgrade</code> - ë³€ê²½ì‚¬í•­ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì ìš©</li>
                        <li><code>flask db downgrade</code> - ì´ì „ ë²„ì „ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</li>
                    </ul>
                    
                    <h6>ğŸŒ± ë°ì´í„° ì‹œë“œ</h6>
                    <ul>
                        <li>ì›¹ UIì—ì„œ "ì‹œë“œ ë°ì´í„° ì‹¤í–‰" ë²„íŠ¼ í´ë¦­</li>
                        <li>ë˜ëŠ” í„°ë¯¸ë„ì—ì„œ <code>python seed_data.py</code> ì‹¤í–‰</li>
                        <li>ì‹¤ì œ ìš´ì˜ ì‹œ <code>seed_data.py</code> íŒŒì¼ì—ì„œ ì•„ë™ ì´ë¦„ê³¼ í¬ì¸íŠ¸ ìˆ˜ì •</li>
                    </ul>
                    
                    <h6>ğŸ’¾ ë°ì´í„° ì´ì‹ (ë…¸íŠ¸ë¶ â†” ì»´í“¨í„°)</h6>
                    <ul>
                        <li><strong>ë°©ë²• 1:</strong> <code>child_center.db</code> íŒŒì¼ì„ ì§ì ‘ ë³µì‚¬</li>
                        <li><strong>ë°©ë²• 2:</strong> ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°ì´í„° ì¬ìƒì„±</li>
                        <li><strong>ë°©ë²• 3:</strong> ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ í†µí•´ ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
async function loadBackupList() {
    const container = document.getElementById('backup-files-container');
    container.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
    
    try {
        const response = await fetch('/backup/status');
        if (!response.ok) {
            throw new Error('ë°±ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        const data = await response.json();
        
        if (!data.backups || data.backups.length === 0) {
            container.innerHTML = '<p class="text-muted">ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        let html = '<div class="table-responsive">';
        html += '<table class="table table-sm table-striped">';
        html += '<thead><tr><th>íŒŒì¼ëª…</th><th>í¬ê¸°</th><th>ìƒì„±ì¼</th><th>ì‘ì—…</th></tr></thead>';
        html += '<tbody>';
        
        data.backups.forEach(backup => {
            const date = new Date(backup.created_at).toLocaleString('ko-KR');
            const size = backup.size_mb + ' MB';
            
            html += `<tr>
                <td><small>${backup.filename}</small></td>
                <td><small>${size}</small></td>
                <td><small>${date}</small></td>
                <td>
                    <button class="btn btn-success btn-sm me-1" onclick="restoreBackup('${backup.filename}')" 
                            title="ë³µì›" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                        <i class="fas fa-download"></i> ë³µì›
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backup.filename}')" 
                            title="ì‚­ì œ" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                        <i class="fas fa-trash"></i> ì‚­ì œ
                    </button>
                </td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = `<p class="text-danger">ì˜¤ë¥˜: ${error.message}</p>`;
    }
}

async function restoreBackup(filename) {
    if (!confirm(`ë°±ì—… íŒŒì¼ "${filename}"ì—ì„œ ë°ì´í„°ë¥¼ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í˜„ì¬ ë°ì´í„°ê°€ ë°±ì—…ìœ¼ë¡œ ë®ì–´ì¨ì§‘ë‹ˆë‹¤!`)) {
        return;
    }
    
    try {
        const response = await fetch(`/backup/restore/${filename}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('âœ… ë°±ì—… ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.reload();
        } else {
            throw new Error('ë°±ì—… ë³µì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        alert(`âŒ ë³µì› ì‹¤íŒ¨: ${error.message}`);
    }
}

function deleteBackup(filename) {
    alert('ë°±ì—… íŒŒì¼ ì‚­ì œ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
}

// ë°±ì—… ëª©ë¡ í† ê¸€ ì‹œ ìë™ ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    const backupListToggle = document.querySelector('[data-bs-toggle="collapse"]');
    if (backupListToggle) {
        backupListToggle.addEventListener('click', function() {
            setTimeout(loadBackupList, 500); // collapse ì• ë‹ˆë©”ì´ì…˜ í›„ ë¡œë“œ
        });
    }
});
</script>
{% endblock %}
{% endblock %} 