{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> 포인트 시각화</h2>
        <div>
            <a href="{{ url_for('points_list') }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-list"></i> 포인트 목록
            </a>
            <a href="{{ url_for('points_analysis') }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-chart-line"></i> 포인트 분석
            </a>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-people"></i> 학년별 비교
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('grade_point_comparison', grade=3) }}">3학년 비교</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('grade_point_comparison', grade=4) }}">4학년 비교</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('grade_point_comparison', grade=5) }}">5학년 비교</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('grade_point_comparison', grade=6) }}">6학년 비교</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 주간 트렌드 & 월별 합계 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> 주간 포인트 트렌드 (최근 28일)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="weeklyChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart"></i> 월별 포인트 합계 ({{ today.year }}년)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 과목별 분포 & 학년별 평균 -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart"></i> 과목별 포인트 분포
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="subjectChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart"></i> 학년별 평균 포인트
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="gradeChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 디버깅을 위한 콘솔 로그
    console.log('Weekly Labels:', {{ weekly_labels | tojson }});
    console.log('Weekly Points:', {{ weekly_points | tojson }});
    console.log('Monthly Labels:', {{ monthly_labels | tojson }});
    console.log('Monthly Points:', {{ monthly_points | tojson }});
    console.log('Subject Labels:', {{ subject_labels | tojson }});
    console.log('Subject Values:', {{ subject_values | tojson }});
    console.log('Grade Labels:', {{ grade_labels | tojson }});
    console.log('Grade Values:', {{ grade_values | tojson }});

    // 주간 트렌드 차트
    try {
        const weeklyCtx = document.getElementById('weeklyChart');
        if (weeklyCtx) {
            console.log('Weekly chart canvas found');
            const ctx = weeklyCtx.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ weekly_labels | tojson }},
                    datasets: [{
                        label: '일일 총 포인트',
                        data: {{ weekly_points | tojson }},
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '포인트'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '날짜'
                            }
                        }
                    }
                }
            });
            console.log('Weekly chart created successfully');
        } else {
            console.error('Weekly chart canvas not found');
        }
    } catch (error) {
        console.error('Error creating weekly chart:', error);
    }

    // 월별 합계 차트
    try {
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx) {
            console.log('Monthly chart canvas found');
            const ctx = monthlyCtx.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: {{ monthly_labels | tojson }},
                    datasets: [{
                        label: '월별 총 포인트',
                        data: {{ monthly_points | tojson }},
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '포인트'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '월'
                            }
                        }
                    }
                }
            });
            console.log('Monthly chart created successfully');
        } else {
            console.error('Monthly chart canvas not found');
        }
    } catch (error) {
        console.error('Error creating monthly chart:', error);
    }

    // 과목별 분포 차트
    try {
        const subjectCtx = document.getElementById('subjectChart');
        if (subjectCtx) {
            console.log('Subject chart canvas found');
            const ctx = subjectCtx.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: {{ subject_labels | tojson }},
                    datasets: [{
                        data: {{ subject_values | tojson }},
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            console.log('Subject chart created successfully');
        } else {
            console.error('Subject chart canvas not found');
        }
    } catch (error) {
        console.error('Error creating subject chart:', error);
    }

    // 학년별 평균 차트
    try {
        const gradeCtx = document.getElementById('gradeChart');
        if (gradeCtx) {
            console.log('Grade chart canvas found');
            const ctx = gradeCtx.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: {{ grade_labels | tojson }},
                    datasets: [{
                        label: '평균 포인트',
                        data: {{ grade_values | tojson }},
                        backgroundColor: 'rgba(255, 159, 64, 0.8)',
                        borderColor: 'rgb(255, 159, 64)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '평균 포인트'
                            },
                            // 작은 값들도 보이도록 Y축 범위 조정
                            suggestedMin: 0,
                            suggestedMax: function(context) {
                                const values = context.chart.data.datasets[0].data;
                                const max = Math.max(...values);
                                return max > 0 ? max * 1.2 : 100; // 최대값이 0이면 100으로 설정
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '학년'
                            }
                        }
                    }
                }
            });
            console.log('Grade chart created successfully');
        } else {
            console.error('Grade chart canvas not found');
        }
    } catch (error) {
        console.error('Error creating grade chart:', error);
    }
});
</script>
{% endblock %} 