{% extends "base.html" %}

{% block title %}포인트 통계{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-chart-bar"></i> 포인트 통계 ({{ today | kst_strftime('%Y년 %m월 %d일') }})</h4>
                </div>
                <div class="card-body">
                    {% if grade_stats %}
                    <div class="row">
                        {% for grade, stats in grade_stats.items() %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header text-center">
                                    <h5 class="mb-0">{{ grade }}학년</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <h6 class="text-muted">평균 포인트</h6>
                                                <h3 class="text-primary">{{ stats.avg_points }}</h3>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <h6 class="text-muted">참여율</h6>
                                                <h3 class="text-success">
                                                    {{ (stats.participated_children / stats.total_children * 100) | round(0) | int }}%
                                                </h3>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">최고점</small>
                                            <div class="text-success">{{ stats.max_points }}</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">최저점</small>
                                            <div class="text-warning">{{ stats.min_points }}</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">참여자</small>
                                            <div class="text-info">{{ stats.participated_children }}/{{ stats.total_children }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- 전체 통계 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie"></i> 전체 통계</h5>
                                </div>
                                <div class="card-body">
                                    {% set total_children = grade_stats.values() | sum(attribute='total_children') %}
                                    {% set total_participated = grade_stats.values() | sum(attribute='participated_children') %}
                                    {% set all_points = [] %}
                                    {% for stats in grade_stats.values() %}
                                        {% for _ in range(stats.participated_children) %}
                                            {% set _ = all_points.append(stats.avg_points) %}
                                        {% endfor %}
                                    {% endfor %}
                                    {% set overall_avg = (all_points | sum / all_points | length) if all_points else 0 %}
                                    
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <h6 class="text-muted">전체 평균</h6>
                                            <h3 class="text-primary">{{ overall_avg | round(0) | int }}</h3>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-muted">전체 참여율</h6>
                                            <h3 class="text-success">{{ (total_participated / total_children * 100) | round(0) | int }}%</h3>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-muted">전체 아동</h6>
                                            <h3 class="text-info">{{ total_children }}명</h3>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-muted">참여 아동</h6>
                                            <h3 class="text-warning">{{ total_participated }}명</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">오늘 포인트 기록이 없습니다.</h5>
                        <p class="text-muted">아동들에게 포인트를 입력해보세요!</p>
                        <a href="{{ url_for('children_list') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> 포인트 입력하기
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 