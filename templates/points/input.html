{% extends "base.html" %}

{% block title %}{{ child.name }} - í¬ì¸íŠ¸ ì…ë ¥{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4>{{ child.name }} ({{ child.grade }}í•™ë…„) - í¬ì¸íŠ¸ ì…ë ¥</h4>
                    <p class="text-muted mb-0">{{ today_record.date.strftime('%Yë…„ %mì›” %dì¼') if today_record else today_date }}</p>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- êµ­ì–´ -->
                        <div class="mb-4">
                            <h5 class="text-primary">êµ­ì–´</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="korean_points" id="korean_200" value="200" 
                                       {% if today_record and today_record.korean_points == 200 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="korean_200">
                                    <i class="fas fa-check-circle"></i> ì™„ë²½ (200ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="korean_points" id="korean_100" value="100" 
                                       {% if today_record and today_record.korean_points == 100 %}checked{% endif %}>
                                <label class="btn btn-outline-warning" for="korean_100">
                                    <i class="fas fa-exclamation-circle"></i> ë¶€ë¶„ (100ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="korean_points" id="korean_0" value="0" 
                                       {% if not today_record or today_record.korean_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="korean_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>
                        </div>

                        <!-- ìˆ˜í•™ -->
                        <div class="mb-4">
                            <h5 class="text-success">ìˆ˜í•™</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="math_points" id="math_200" value="200" 
                                       {% if today_record and today_record.math_points == 200 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="math_200">
                                    <i class="fas fa-check-circle"></i> ì™„ë²½ (200ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="math_points" id="math_100" value="100" 
                                       {% if today_record and today_record.math_points == 100 %}checked{% endif %}>
                                <label class="btn btn-outline-warning" for="math_100">
                                    <i class="fas fa-exclamation-circle"></i> ë¶€ë¶„ (100ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="math_points" id="math_0" value="0" 
                                       {% if not today_record or today_record.math_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="math_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>
                        </div>

                        <!-- ìˆìˆ˜í•™ -->
                        <div class="mb-4">
                            <h5 class="text-info">ìˆìˆ˜í•™</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="ssen_points" id="ssen_200" value="200" 
                                       {% if today_record and today_record.ssen_points == 200 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="ssen_200">
                                    <i class="fas fa-check-circle"></i> ì™„ë²½ (200ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="ssen_points" id="ssen_100" value="100" 
                                       {% if today_record and today_record.ssen_points == 100 %}checked{% endif %}>
                                <label class="btn btn-outline-warning" for="ssen_100">
                                    <i class="fas fa-exclamation-circle"></i> ë¶€ë¶„ (100ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="ssen_points" id="ssen_0" value="0" 
                                       {% if not today_record or today_record.ssen_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="ssen_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>
                        </div>

                        <!-- ë…ì„œ -->
                        <div class="mb-4">
                            <h5 class="text-warning">ë…ì„œ</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="reading_points" id="reading_200" value="200" 
                                       {% if today_record and today_record.reading_points == 200 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="reading_200">
                                    <i class="fas fa-check-circle"></i> ì™„ë²½ (200ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="reading_points" id="reading_100" value="100" 
                                       {% if today_record and today_record.reading_points == 100 %}checked{% endif %}>
                                <label class="btn btn-outline-warning" for="reading_100">
                                    <i class="fas fa-exclamation-circle"></i> ë¶€ë¶„ (100ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="reading_points" id="reading_0" value="0" 
                                       {% if not today_record or today_record.reading_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="reading_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>

                        <!-- í”¼ì•„ë…¸ -->
                        <div class="mb-4">
                            <h5 class="text-info">í”¼ì•„ë…¸</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="piano_points" id="piano_100" value="100" 
                                       {% if today_record and today_record.piano_points == 100 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="piano_100">
                                    <i class="fas fa-check-circle"></i> ì™„ë£Œ (100ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="piano_points" id="piano_0" value="0" 
                                       {% if not today_record or today_record.piano_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="piano_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>
                        </div>

                        <!-- ì˜ì–´ -->
                        <div class="mb-4">
                            <h5 class="text-primary">ì˜ì–´</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="english_points" id="english_100" value="100" 
                                       {% if today_record and today_record.english_points == 100 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="english_100">
                                    <i class="fas fa-check-circle"></i> ì™„ë£Œ (100ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="english_points" id="english_0" value="0" 
                                       {% if not today_record or today_record.english_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="english_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>
                        </div>

                        <!-- ê³ í•™ë…„ìˆ˜í•™ -->
                        <div class="mb-4">
                            <h5 class="text-danger">ê³ í•™ë…„ìˆ˜í•™</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="advanced_math_points" id="advanced_math_300" value="300" 
                                       {% if today_record and today_record.advanced_math_points == 300 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="advanced_math_300">
                                    <i class="fas fa-check-circle"></i> ì™„ë£Œ (300ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="advanced_math_points" id="advanced_math_0" value="0" 
                                       {% if not today_record or today_record.advanced_math_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="advanced_math_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>
                        </div>

                        <!-- ì“°ê¸° -->
                        <div class="mb-4">
                            <h5 class="text-secondary">ì“°ê¸°</h5>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="writing_points" id="writing_100" value="100" 
                                       {% if today_record and today_record.writing_points == 100 %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="writing_100">
                                    <i class="fas fa-check-circle"></i> ì™„ë£Œ (100ì )
                                </label>
                                
                                <input type="radio" class="btn-check" name="writing_points" id="writing_0" value="0" 
                                       {% if not today_record or today_record.writing_points == 0 %}checked{% endif %}>
                                <label class="btn btn-outline-secondary" for="writing_0">
                                    <i class="fas fa-times-circle"></i> ë¯¸ì™„ë£Œ (0ì )
                                </label>
                            </div>
                        </div>
                        </div>

                        <!-- ì´ì  ë¯¸ë¦¬ë³´ê¸° -->
                        <div class="alert alert-info">
                            <h6 class="mb-2"><i class="fas fa-calculator"></i> ì´ì  ë¯¸ë¦¬ë³´ê¸°</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">êµ­ì–´:</small>
                                    <span id="korean_preview">0</span>ì 
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ìˆ˜í•™:</small>
                                    <span id="math_preview">0</span>ì 
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ìˆìˆ˜í•™:</small>
                                    <span id="ssen_preview">0</span>ì 
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ë…ì„œ:</small>
                                    <span id="reading_preview">0</span>ì 
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <small class="text-muted">í”¼ì•„ë…¸:</small>
                                    <span id="piano_preview">0</span>ì 
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ì˜ì–´:</small>
                                    <span id="english_preview">0</span>ì 
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ê³ í•™ë…„ìˆ˜í•™:</small>
                                    <span id="advanced_math_preview">0</span>ì 
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">ì“°ê¸°:</small>
                                    <span id="writing_preview">0</span>ì 
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <h4 class="text-primary mb-0">
                                    ì´ì : <span id="total_preview">0</span>ì 
                                </h4>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('children_list') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> ëŒì•„ê°€ê¸°
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì´ì  ê³„ì‚° í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „)
function updateTotalScore() {
    try {
        // ì„ íƒëœ ë¼ë””ì˜¤ ë²„íŠ¼ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const korean = parseInt(document.querySelector('input[name="korean_points"]:checked')?.value || 0);
        const math = parseInt(document.querySelector('input[name="math_points"]:checked')?.value || 0);
        const ssen = parseInt(document.querySelector('input[name="ssen_points"]:checked')?.value || 0);
        const reading = parseInt(document.querySelector('input[name="reading_points"]:checked')?.value || 0);
        const piano = parseInt(document.querySelector('input[name="piano_points"]:checked')?.value || 0);
        const english = parseInt(document.querySelector('input[name="english_points"]:checked')?.value || 0);
        const advanced_math = parseInt(document.querySelector('input[name="advanced_math_points"]:checked')?.value || 0);
        const writing = parseInt(document.querySelector('input[name="writing_points"]:checked')?.value || 0);
        
        // ê°’ ê²€ì¦: NaN ì²´í¬
        if (isNaN(korean) || isNaN(math) || isNaN(ssen) || isNaN(reading) || isNaN(piano) || isNaN(english) || isNaN(advanced_math) || isNaN(writing)) {
            console.error('âŒ ì˜ëª»ëœ í¬ì¸íŠ¸ ê°’ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ê°’ ê²€ì¦: ë²”ìœ„ ì²´í¬ (ê° ê³¼ëª©ë³„ ìµœëŒ€ê°’ ë‹¤ë¦„)
        const values = [korean, math, ssen, reading, piano, english, advanced_math, writing];
        const maxValues = [200, 200, 200, 200, 100, 100, 300, 100]; // ê° ê³¼ëª©ë³„ ìµœëŒ€ê°’
        for (let i = 0; i < values.length; i++) {
            if (values[i] < 0 || values[i] > maxValues[i]) {
                console.error(`âŒ í¬ì¸íŠ¸ ê°’ì´ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤: ${values[i]} (ìµœëŒ€: ${maxValues[i]})`);
                return;
            }
        }
        
        // ì´ì  ê³„ì‚° (ê²€ì¦ëœ ê°’ìœ¼ë¡œ)
        const total = values.reduce((sum, val) => sum + val, 0);
        
        // ê³„ì‚° ê²°ê³¼ ê²€ì¦
        const expectedTotal = korean + math + ssen + reading + piano + english + advanced_math + writing;
        if (total !== expectedTotal) {
            console.error(`âŒ í¬ì¸íŠ¸ ê³„ì‚° ì˜¤ë¥˜: ì˜ˆìƒ ${expectedTotal}, ê³„ì‚° ${total}`);
            return;
        }
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('korean_preview').textContent = korean;
        document.getElementById('math_preview').textContent = math;
        document.getElementById('ssen_preview').textContent = ssen;
        document.getElementById('reading_preview').textContent = reading;
        document.getElementById('piano_preview').textContent = piano;
        document.getElementById('english_preview').textContent = english;
        document.getElementById('advanced_math_preview').textContent = advanced_math;
        document.getElementById('writing_preview').textContent = writing;
        document.getElementById('total_preview').textContent = total;
        
        // ì´ì  ìƒ‰ìƒ ë³€ê²½ (ì‹œê°ì  í”¼ë“œë°±)
        const totalElement = document.getElementById('total_preview');
        if (total >= 600) {
            totalElement.className = 'text-success fw-bold';
        } else if (total >= 400) {
            totalElement.className = 'text-warning fw-bold';
        } else {
            totalElement.className = 'text-danger fw-bold';
        }
        
        console.log(`âœ… í¬ì¸íŠ¸ ê³„ì‚° ì™„ë£Œ: êµ­ì–´(${korean}) + ìˆ˜í•™(${math}) + ìˆìˆ˜í•™(${ssen}) + ë…ì„œ(${reading}) + í”¼ì•„ë…¸(${piano}) + ì˜ì–´(${english}) + ê³ í•™ë…„ìˆ˜í•™(${advanced_math}) + ì“°ê¸°(${writing}) = ${total}`);
        
    } catch (error) {
        console.error('âŒ í¬ì¸íŠ¸ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    }
}

// ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì‹œ ì´ì  ì—…ë°ì´íŠ¸
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        updateTotalScore();
        
        // ì„ íƒëœ ê³¼ëª© í•˜ì´ë¼ì´íŠ¸
        const subjectName = this.name.replace('_points', '');
        const subjectSection = this.closest('.mb-4');
        
        // ëª¨ë“  ê³¼ëª© ì„¹ì…˜ì—ì„œ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        document.querySelectorAll('.mb-4').forEach(section => {
            section.classList.remove('border-primary', 'border-2');
        });
        
        // ì„ íƒëœ ê³¼ëª© ì„¹ì…˜ í•˜ì´ë¼ì´íŠ¸
        if (this.checked) {
            subjectSection.classList.add('border-primary', 'border-2');
        }
    });
});

// í¼ ì œì¶œ ì „ ìµœì¢… ê²€ì¦
document.querySelector('form').addEventListener('submit', function(e) {
    try {
        // ì„ íƒëœ í¬ì¸íŠ¸ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
        const korean = parseInt(document.querySelector('input[name="korean_points"]:checked')?.value || 0);
        const math = parseInt(document.querySelector('input[name="math_points"]:checked')?.value || 0);
        const ssen = parseInt(document.querySelector('input[name="ssen_points"]:checked')?.value || 0);
        const reading = parseInt(document.querySelector('input[name="reading_points"]:checked')?.value || 0);
        const piano = parseInt(document.querySelector('input[name="piano_points"]:checked')?.value || 0);
        const english = parseInt(document.querySelector('input[name="english_points"]:checked')?.value || 0);
        const advanced_math = parseInt(document.querySelector('input[name="advanced_math_points"]:checked')?.value || 0);
        const writing = parseInt(document.querySelector('input[name="writing_points"]:checked')?.value || 0);
        
        // ìµœì¢… ê²€ì¦
        if (isNaN(korean) || isNaN(math) || isNaN(ssen) || isNaN(reading) || isNaN(piano) || isNaN(english) || isNaN(advanced_math) || isNaN(writing)) {
            e.preventDefault();
            alert('âŒ ëª¨ë“  ê³¼ëª©ì˜ í¬ì¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return false;
        }
        
        // ì´ì  ì¬ê³„ì‚° ë° ê²€ì¦
        const total = korean + math + ssen + reading + piano + english + advanced_math + writing;
        const expectedTotal = korean + math + ssen + reading + piano + english + advanced_math + writing;
        
        if (total !== expectedTotal) {
            e.preventDefault();
            alert(`âŒ í¬ì¸íŠ¸ ê³„ì‚° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
            return false;
        }
        
        // ì„±ê³µ ë©”ì‹œì§€
        console.log(`âœ… í¼ ì œì¶œ ê²€ì¦ ì™„ë£Œ: ì´ì  ${total}ì `);
        
    } catch (error) {
        e.preventDefault();
        console.error('âŒ í¼ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert('âŒ í¼ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return false;
    }
});

// ë°°ì—´ í•©ê³„ í•¨ìˆ˜
function sum(arr) {
    return arr.reduce((sum, val) => sum + val, 0);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì´ì  ê³„ì‚°
document.addEventListener('DOMContentLoaded', function() {
    updateTotalScore();
    
    // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
    console.log('ğŸš€ í¬ì¸íŠ¸ ì…ë ¥ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    console.log('ğŸ“Š ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ê³„ì‚° ì‹œìŠ¤í…œ í™œì„±í™”');
});
</script>
{% endblock %} 