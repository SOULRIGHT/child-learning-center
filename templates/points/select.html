{% extends "base.html" %}

{% block title %}í¬ì¸íŠ¸ ì…ë ¥ - ì•„ë™ ì„ íƒ{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <!-- í˜ì´ì§€ í—¤ë” -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-star me-2"></i>í¬ì¸íŠ¸ ì…ë ¥ - ì•„ë™ ì„ íƒ
                    </h4>
                    <p class="mb-0 mt-2">í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•  ì•„ë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                </div>
            </div>
            
            <!-- ì•„ë™ ì„ íƒ ì¹´ë“œ -->
            <div class="card">
                <div class="card-body">
                    <!-- ë°ìŠ¤í¬í†±/íƒœë¸”ë¦¿ ë ˆì´ì•„ì›ƒ -->
                    <div class="row d-none d-md-flex">
                        <div class="col-md-4">
                            <label for="gradeFilter" class="form-label">
                                <i class="fas fa-filter me-2 text-primary"></i>í•™ë…„ í•„í„°
                            </label>
                            <select id="gradeFilter" class="form-select">
                                <option value="">ì „ì²´ í•™ë…„</option>
                                <option value="1">1í•™ë…„</option>
                                <option value="2">2í•™ë…„</option>
                                <option value="3">3í•™ë…„</option>
                                <option value="4">4í•™ë…„</option>
                                <option value="5">5í•™ë…„</option>
                                <option value="6">6í•™ë…„</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="childSelector" class="form-label">
                                <i class="fas fa-user me-2 text-success"></i>ì•„ë™ ì„ íƒ
                            </label>
                            <select id="childSelector" class="form-select">
                                <option value="">ì•„ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <!-- JavaScriptë¡œ ë™ì  ë¡œë”© -->
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button id="goToInput" class="btn btn-primary w-100 py-2 d-flex justify-content-center align-items-center">
                                ì…ë ¥
                            </button>
                        </div>
                    </div>
                    
                    <!-- ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ -->
                    <div class="d-md-none">
                        <div class="mb-3">
                            <label for="gradeFilterMobile" class="form-label">
                                <i class="fas fa-filter me-2 text-primary"></i>í•™ë…„ í•„í„°
                            </label>
                            <select id="gradeFilterMobile" class="form-select">
                                <option value="">ì „ì²´ í•™ë…„</option>
                                <option value="1">1í•™ë…„</option>
                                <option value="2">2í•™ë…„</option>
                                <option value="3">3í•™ë…„</option>
                                <option value="4">4í•™ë…„</option>
                                <option value="5">5í•™ë…„</option>
                                <option value="6">6í•™ë…„</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="childSelectorMobile" class="form-label">
                                <i class="fas fa-user me-2 text-success"></i>ì•„ë™ ì„ íƒ
                            </label>
                            <select id="childSelectorMobile" class="form-select">
                                <option value="">ì•„ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <!-- JavaScriptë¡œ ë™ì  ë¡œë”© -->
                            </select>
                        </div>
                        <div class="d-grid">
                            <button id="goToInputMobile" class="btn btn-primary btn-lg py-3 d-flex justify-content-center align-items-center">
                                ì…ë ¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle me-2"></i>ì•ˆë‚´ì‚¬í•­</h6>
                <ul class="mb-0">
                    <li>í•™ë…„ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™ë…„ ì•„ë™ë§Œ í‘œì‹œë©ë‹ˆë‹¤</li>
                    <li>ì•„ë™ì„ ì„ íƒí•œ í›„ "ì…ë ¥í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
                    <li>ë§¤ì¼ í•œ ë²ˆì”© í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤</li>
                </ul>
            </div>
            
            <!-- ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightning-bolt me-2 text-warning"></i>ë¹ ë¥¸ ì•¡ì„¸ìŠ¤
                    </h6>
                </div>
                <div class="card-body" id="quickAccessContainer">
                    <!-- JavaScriptë¡œ ìµœê·¼ ì•„ë™ë“¤ í‘œì‹œ -->
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// í•™ë…„ë³„ ì•„ë™ ëª©ë¡ ë¡œë”© í•¨ìˆ˜
async function loadChildrenByGrade(grade = '') {
    try {
        console.log(`ğŸ“‹ ì•„ë™ ëª©ë¡ ë¡œë”©... (í•™ë…„: ${grade || 'ì „ì²´'})`);
        
        const url = grade ? `/api/children/by-grade?grade=${grade}` : '/api/children/by-grade';
        const response = await fetch(url);
        const data = await response.json();
        
        const selector = document.getElementById('childSelector');
        selector.innerHTML = '<option value="">ì•„ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        
        if (data.success && data.children.length > 0) {
            data.children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = child.display_name;
                selector.appendChild(option);
            });
            console.log(`âœ… ${data.children.length}ëª…ì˜ ì•„ë™ ë¡œë”© ì™„ë£Œ`);
        } else {
            console.log('âš ï¸ ì¡°ê±´ì— ë§ëŠ” ì•„ë™ì´ ì—†ìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        console.error('âŒ ì•„ë™ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
        alert('ì•„ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í•™ë…„ë³„ ì•„ë™ ëª©ë¡ ë¡œë”© í•¨ìˆ˜ (ëª¨ë°”ì¼)
async function loadChildrenByGradeMobile(grade = '') {
    try {
        console.log(`ğŸ“‹ ì•„ë™ ëª©ë¡ ë¡œë”© (ëª¨ë°”ì¼)... (í•™ë…„: ${grade || 'ì „ì²´'})`);
        
        const url = grade ? `/api/children/by-grade?grade=${grade}` : '/api/children/by-grade';
        const response = await fetch(url);
        const data = await response.json();
        
        const selector = document.getElementById('childSelectorMobile');
        selector.innerHTML = '<option value="">ì•„ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        
        if (data.success && data.children.length > 0) {
            data.children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = child.display_name;
                selector.appendChild(option);
            });
            console.log(`âœ… ${data.children.length}ëª…ì˜ ì•„ë™ ë¡œë”© ì™„ë£Œ (ëª¨ë°”ì¼)`);
        } else {
            console.log('âš ï¸ ì¡°ê±´ì— ë§ëŠ” ì•„ë™ì´ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë°”ì¼)');
        }
    } catch (error) {
        console.error('âŒ ì•„ë™ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜ (ëª¨ë°”ì¼):', error);
        alert('ì•„ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ ì•„ë™ ëª©ë¡ ë¡œë”©
async function loadQuickAccess() {
    try {
        const response = await fetch('/api/children/by-grade');
        const data = await response.json();
        
        const container = document.getElementById('quickAccessContainer');
        
        if (data.success && data.children.length > 0) {
            // í•™ë…„ë³„ë¡œ ê·¸ë£¹í™”
            const gradeGroups = {};
            data.children.forEach(child => {
                if (!gradeGroups[child.grade]) {
                    gradeGroups[child.grade] = [];
                }
                gradeGroups[child.grade].push(child);
            });
            
            let html = '';
            Object.keys(gradeGroups).sort().forEach(grade => {
                html += `<div class="mb-3">`;
                html += `<h6 class="text-muted mb-2">${grade}í•™ë…„</h6>`;
                html += `<div class="d-flex flex-wrap gap-2">`;
                
                gradeGroups[grade].forEach(child => {
                    html += `
                        <button class="btn btn-outline-primary btn-sm quick-child-btn" 
                                data-child-id="${child.id}" 
                                data-child-name="${child.name}">
                            ${child.name}
                        </button>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            
            // ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€ (í™•ì¸ ë©”ì‹œì§€ ì—†ì´ ë°”ë¡œ ì´ë™)
            document.querySelectorAll('.quick-child-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const childId = this.dataset.childId;
                    const childName = this.dataset.childName;
                    
                    console.log(`ğŸ¯ ë¹ ë¥¸ ì„ íƒ: ${childName} (ID: ${childId})`);
                    window.location.href = `/points/input/${childId}`;
                });
            });
        } else {
            container.innerHTML = '<p class="text-muted text-center">ë“±ë¡ëœ ì•„ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    } catch (error) {
        console.error('âŒ ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ ë¡œë”© ì˜¤ë¥˜:', error);
        const container = document.getElementById('quickAccessContainer');
        container.innerHTML = '<p class="text-danger text-center">ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ì•„ë™ ì„ íƒ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    
    // ì „ì²´ ì•„ë™ ëª©ë¡ ë¡œë”© (ë°ìŠ¤í¬í†± & ëª¨ë°”ì¼)
    loadChildrenByGrade();
    loadChildrenByGradeMobile();
    
    // ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ ë¡œë”©
    loadQuickAccess();
    
    // í•™ë…„ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬í†±)
    document.getElementById('gradeFilter').addEventListener('change', function() {
        const selectedGrade = this.value;
        console.log(`ğŸ”„ í•™ë…„ í•„í„° ë³€ê²½: ${selectedGrade || 'ì „ì²´'}`);
        loadChildrenByGrade(selectedGrade);
        
        // ëª¨ë°”ì¼ ë²„ì „ë„ ë™ê¸°í™”
        document.getElementById('gradeFilterMobile').value = selectedGrade;
        loadChildrenByGradeMobile(selectedGrade);
    });
    
    // í•™ë…„ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼)
    document.getElementById('gradeFilterMobile').addEventListener('change', function() {
        const selectedGrade = this.value;
        console.log(`ğŸ”„ í•™ë…„ í•„í„° ë³€ê²½ (ëª¨ë°”ì¼): ${selectedGrade || 'ì „ì²´'}`);
        loadChildrenByGradeMobile(selectedGrade);
        
        // ë°ìŠ¤í¬í†± ë²„ì „ë„ ë™ê¸°í™”
        document.getElementById('gradeFilter').value = selectedGrade;
        loadChildrenByGrade(selectedGrade);
    });
    
    // ì…ë ¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë°ìŠ¤í¬í†±)
    document.getElementById('goToInput').addEventListener('click', function() {
        const selectedChildId = document.getElementById('childSelector').value;
        
        if (!selectedChildId) {
            alert('ì•„ë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const childSelector = document.getElementById('childSelector');
        const selectedChildName = childSelector.options[childSelector.selectedIndex].text;
        
        console.log(`ğŸ¯ ì„ íƒëœ ì•„ë™: ${selectedChildName} (ID: ${selectedChildId})`);
        window.location.href = `/points/input/${selectedChildId}`;
    });
    
    // ì…ë ¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼)
    document.getElementById('goToInputMobile').addEventListener('click', function() {
        const selectedChildId = document.getElementById('childSelectorMobile').value;
        
        if (!selectedChildId) {
            alert('ì•„ë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const childSelector = document.getElementById('childSelectorMobile');
        const selectedChildName = childSelector.options[childSelector.selectedIndex].text;
        
        console.log(`ğŸ¯ ì„ íƒëœ ì•„ë™ (ëª¨ë°”ì¼): ${selectedChildName} (ID: ${selectedChildId})`);
        window.location.href = `/points/input/${selectedChildId}`;
    });
});
</script>
{% endblock %}
