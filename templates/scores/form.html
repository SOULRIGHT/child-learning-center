{% extends "base.html" %}

{% block title %}
{% if record %}ì ìˆ˜ ìˆ˜ì •{% else %}ì ìˆ˜ ì…ë ¥{% endif %} - ì§€ì—­ì•„ë™ì„¼í„° í•™ìŠµê´€ë¦¬
{% endblock %}

{% block page_title %}
{% if record %}ì ìˆ˜ ìˆ˜ì •{% else %}ì ìˆ˜ ì…ë ¥{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- í—¤ë” -->
        <div class="d-flex align-items-center mb-4">
            <a href="{{ url_for('scores_list') if not record else url_for('child_detail', child_id=record.child_id) }}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <h4 class="fw-bold text-dark mb-1">
                    {% if record %}
                        {{ record.child.name }} - {{ record.date | kst_strftime('%Yë…„ %mì›” %dì¼') }} ì ìˆ˜ ìˆ˜ì •
                    {% else %}
                        í•™ìŠµ ì ìˆ˜ ì…ë ¥
                    {% endif %}
                </h4>
                <p class="text-muted mb-0">
                    {% if record %}
                        ê¸°ì¡´ ì ìˆ˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    {% else %}
                        êµ­ì–´, ìˆ ìˆ˜í•™, ë…ì„œ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- í¼ -->
        <form method="POST" id="scoreForm" novalidate>
            <div class="row">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calendar-event me-2"></i>ê¸°ë³¸ ì •ë³´
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- ì•„ë™ ì„ íƒ -->
                            {% if not record %}
                            <div class="mb-3">
                                <label for="child_id" class="form-label fw-bold">
                                    <i class="bi bi-person me-1"></i>ì•„ë™ ì„ íƒ
                                    <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" id="child_id" name="child_id" required>
                                    <option value="">ì•„ë™ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for child in children %}
                                    <option value="{{ child.id }}" {% if preselected_child_id == child.id %}selected{% endif %}>
                                        {{ child.name }} ({{ child.grade }}í•™ë…„)
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    ì ìˆ˜ë¥¼ ì…ë ¥í•  ì•„ë™ì„ ì„ íƒí•˜ì„¸ìš”.
                                </div>
                            </div>
                            {% else %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">ì•„ë™</label>
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                                         style="width: 40px; height: 40px; font-weight: 600;">
                                        {{ record.child.name[0] }}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ record.child.name }}</div>
                                        <small class="text-muted">{{ record.child.grade }}í•™ë…„</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- ë‚ ì§œ ì…ë ¥ -->
                            <div class="mb-3">
                                <label for="date" class="form-label fw-bold">
                                    <i class="bi bi-calendar me-1"></i>í•™ìŠµ ë‚ ì§œ
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="date" 
                                       class="form-control form-control-lg" 
                                       id="date" 
                                       name="date" 
                                       value="{{ record.date | kst_strftime('%Y-%m-%d') if record else '' }}"
                                       required>
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i>
                                    í•™ìŠµí•œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.
                                </div>
                            </div>

                            <!-- ì ìˆ˜ ê³„ì‚° ì•ˆë‚´ -->
                            <div class="alert alert-info">
                                <i class="bi bi-calculator me-2"></i>
                                <strong>ì ìˆ˜ ê³„ì‚° ë°©ì‹:</strong>
                                <div class="mt-2 small">
                                    â€¢ êµ­ì–´/ìˆ˜í•™: (ë§ì€ ë¬¸ì œ Ã· í‘¼ ë¬¸ì œ) Ã— 100ì <br>
                                    â€¢ ë…ì„œ: ì™„ë… 200ì , ë¶€ë¶„ë…ì„œ 100ì , ë¯¸ì‹¤ì‹œ 0ì <br>
                                    â€¢ ì´ì : êµ­ì–´ + ìˆ˜í•™ + ë…ì„œ (ìµœëŒ€ 400ì )
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- êµ­ì–´ ì ìˆ˜ -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-book me-2"></i>êµ­ì–´
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label for="korean_problems_solved" class="form-label fw-bold">í‘¼ ë¬¸ì œ ìˆ˜</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="korean_problems_solved" 
                                           name="korean_problems_solved" 
                                           value="{{ record.korean_problems_solved if record else '' }}"
                                           min="0" 
                                           max="200"
                                           placeholder="0">
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="korean_problems_correct" class="form-label fw-bold">ë§ì€ ë¬¸ì œ ìˆ˜</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="korean_problems_correct" 
                                           name="korean_problems_correct" 
                                           value="{{ record.korean_problems_correct if record else '' }}"
                                           min="0" 
                                           max="200"
                                           placeholder="0">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="korean_last_page" class="form-label fw-bold">ë§ˆì§€ë§‰ í˜ì´ì§€</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="korean_last_page" 
                                       name="korean_last_page" 
                                       value="{{ record.korean_last_page if record else '' }}"
                                       min="0" 
                                       max="1000"
                                       placeholder="0">
                            </div>

                            <!-- ì ìˆ˜ ë¯¸ë¦¬ë³´ê¸° -->
                            <div class="alert alert-light border">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">ì˜ˆìƒ ì ìˆ˜:</span>
                                    <span id="korean_score_preview" class="badge bg-primary fs-6">0ì </span>
                                </div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div id="korean_progress" class="progress-bar bg-primary" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìˆ ìˆ˜í•™ ì ìˆ˜ -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calculator me-2"></i>ìˆ ìˆ˜í•™
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label for="math_problems_solved" class="form-label fw-bold">í‘¼ ë¬¸ì œ ìˆ˜</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="math_problems_solved" 
                                           name="math_problems_solved" 
                                           value="{{ record.math_problems_solved if record else '' }}"
                                           min="0" 
                                           max="200"
                                           placeholder="0">
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="math_problems_correct" class="form-label fw-bold">ë§ì€ ë¬¸ì œ ìˆ˜</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="math_problems_correct" 
                                           name="math_problems_correct" 
                                           value="{{ record.math_problems_correct if record else '' }}"
                                           min="0" 
                                           max="200"
                                           placeholder="0">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="math_last_page" class="form-label fw-bold">ë§ˆì§€ë§‰ í˜ì´ì§€</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="math_last_page" 
                                       name="math_last_page" 
                                       value="{{ record.math_last_page if record else '' }}"
                                       min="0" 
                                       max="1000"
                                       placeholder="0">
                            </div>

                            <!-- ì ìˆ˜ ë¯¸ë¦¬ë³´ê¸° -->
                            <div class="alert alert-light border">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">ì˜ˆìƒ ì ìˆ˜:</span>
                                    <span id="math_score_preview" class="badge bg-success fs-6">0ì </span>
                                </div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div id="math_progress" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë…ì„œ ì ìˆ˜ -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-journal-text me-2"></i>ë…ì„œ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold mb-3">ë…ì„œ ìƒíƒœ</label>
                                <div class="d-grid gap-2">
                                    <button type="button" 
                                            class="btn btn-lg reading-status-btn {% if record and record.reading_score == 200 %}btn-success active{% else %}btn-outline-success{% endif %}" 
                                            data-value="complete" 
                                            onclick="selectReadingStatus(this, 'complete')">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="text-start">
                                                <div class="fw-bold">ğŸŸ¢ ì™„ë…</div>
                                                <small>ë‹¤ ì½ì—ˆì„ ë•Œ</small>
                                            </div>
                                            <div>
                                                <span class="badge bg-white text-success fs-6">200ì </span>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <button type="button" 
                                            class="btn btn-lg reading-status-btn {% if record and record.reading_score == 100 %}btn-warning active{% else %}btn-outline-warning{% endif %}" 
                                            data-value="partial" 
                                            onclick="selectReadingStatus(this, 'partial')">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="text-start">
                                                <div class="fw-bold">ğŸŸ¡ ë¶€ë¶„ë…ì„œ</div>
                                                <small>ì‹œì‘í–ˆì§€ë§Œ ë¯¸ì™„ë£Œ/íƒœë„ë¶ˆëŸ‰</small>
                                            </div>
                                            <div>
                                                <span class="badge bg-white text-warning fs-6">100ì </span>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <button type="button" 
                                            class="btn btn-lg reading-status-btn {% if not record or record.reading_score == 0 %}btn-secondary active{% else %}btn-outline-secondary{% endif %}" 
                                            data-value="none" 
                                            onclick="selectReadingStatus(this, 'none')">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="text-start">
                                                <div class="fw-bold">âš« ë¯¸ì‹¤ì‹œ</div>
                                                <small>ì•ˆ í•¨</small>
                                            </div>
                                            <div>
                                                <span class="badge {% if not record or record.reading_score == 0 %}bg-white text-dark{% else %}bg-white text-secondary{% endif %} fs-6">0ì </span>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                                
                                <input type="hidden" id="reading_status" name="reading_status" value="{% if record and record.reading_score == 200 %}complete{% elif record and record.reading_score == 100 %}partial{% else %}none{% endif %}">
                                <input type="hidden" id="reading_score" name="reading_score" value="{{ record.reading_score if record else 0 }}">
                                <input type="hidden" id="reading_completed" name="reading_completed" value="{{ 'true' if record and record.reading_completed else 'false' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì´ì  ë¯¸ë¦¬ë³´ê¸° -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-trophy me-2"></i>ì´ì  ë¯¸ë¦¬ë³´ê¸°
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <div class="display-4 fw-bold text-primary mb-3" id="total_score_preview">0ì </div>
                                <div class="progress mb-3" style="height: 20px;">
                                    <div id="total_progress" class="progress-bar bg-gradient" style="width: 0%"></div>
                                </div>
                                <div id="score_rating" class="badge bg-secondary fs-6">ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
                            </div>

                            <hr>

                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="text-primary fw-bold" id="korean_contribution">0ì </div>
                                    <small class="text-muted">êµ­ì–´</small>
                                </div>
                                <div class="col-4">
                                    <div class="text-success fw-bold" id="math_contribution">0ì </div>
                                    <small class="text-muted">ìˆ˜í•™</small>
                                </div>
                                <div class="col-4">
                                    <div class="text-info fw-bold" id="reading_contribution">0ì </div>
                                    <small class="text-muted">ë…ì„œ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-primary btn-lg flex-fill">
                                    <i class="bi bi-{% if record %}check-circle{% else %}plus-circle{% endif %} me-2"></i>
                                    {% if record %}ì ìˆ˜ ìˆ˜ì • ì™„ë£Œ{% else %}ì ìˆ˜ ì €ì¥í•˜ê¸°{% endif %}
                                </button>
                                <a href="{{ url_for('scores_list') if not record else url_for('child_detail', child_id=record.child_id) }}" 
                                   class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-x-circle me-2"></i>ì·¨ì†Œ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/reading-test.js') }}"></script>
<script>
// ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ì „ì—­)
function calculateScore(correct, total) {
    if (total === 0 || correct === 0) return 0;
    return (correct / total) * 100;
}
// ë…ì„œ í•¨ìˆ˜ëŠ” ë³„ë„ JS íŒŒì¼ì—ì„œ ë¡œë“œë¨

document.addEventListener('DOMContentLoaded', function() {

    // ì‹¤ì‹œê°„ ì ìˆ˜ ê³„ì‚° ë° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    function updatePreviews() {
        // êµ­ì–´ ì ìˆ˜ ê³„ì‚°
        var koreanSolved = parseInt(document.getElementById('korean_problems_solved').value) || 0;
        var koreanCorrect = parseInt(document.getElementById('korean_problems_correct').value) || 0;
        var koreanScore = calculateScore(koreanCorrect, koreanSolved);
        
        // ìˆ˜í•™ ì ìˆ˜ ê³„ì‚°
        var mathSolved = parseInt(document.getElementById('math_problems_solved').value) || 0;
        var mathCorrect = parseInt(document.getElementById('math_problems_correct').value) || 0;
        var mathScore = calculateScore(mathCorrect, mathSolved);
        
        // ë…ì„œ ì ìˆ˜
        var readingScore = parseFloat(document.getElementById('reading_score').value) || 0;
        
        // ì´ì  ê³„ì‚°
        var totalScore = koreanScore + mathScore + readingScore;
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('korean_score_preview').textContent = koreanScore.toFixed(1) + 'ì ';
        document.getElementById('math_score_preview').textContent = mathScore.toFixed(1) + 'ì ';
        document.getElementById('total_score_preview').textContent = totalScore.toFixed(1) + 'ì ';
        
        // ê¸°ì—¬ë„ í‘œì‹œ
        document.getElementById('korean_contribution').textContent = koreanScore.toFixed(1) + 'ì ';
        document.getElementById('math_contribution').textContent = mathScore.toFixed(1) + 'ì ';
        document.getElementById('reading_contribution').textContent = readingScore.toFixed(1) + 'ì ';
        
        // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
        document.getElementById('korean_progress').style.width = koreanScore + '%';
        document.getElementById('math_progress').style.width = mathScore + '%';
        document.getElementById('total_progress').style.width = Math.min((totalScore / 4), 100) + '%';
        
        // ë“±ê¸‰ í‘œì‹œ
        var ratingElement = document.getElementById('score_rating');
        var progressElement = document.getElementById('total_progress');
        
        if (totalScore >= 370) {
            ratingElement.textContent = 'ìµœìš°ìˆ˜';
            ratingElement.className = 'badge bg-warning fs-6';
            progressElement.className = 'progress-bar bg-warning';
        } else if (totalScore >= 320) {
            ratingElement.textContent = 'ìš°ìˆ˜';
            ratingElement.className = 'badge bg-success fs-6';
            progressElement.className = 'progress-bar bg-success';
        } else if (totalScore >= 250) {
            ratingElement.textContent = 'ë³´í†µ';
            ratingElement.className = 'badge bg-info fs-6';
            progressElement.className = 'progress-bar bg-info';
        } else if (totalScore > 0) {
            ratingElement.textContent = 'ì£¼ì˜';
            ratingElement.className = 'badge bg-danger fs-6';
            progressElement.className = 'progress-bar bg-danger';
        } else {
            ratingElement.textContent = 'ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
            ratingElement.className = 'badge bg-secondary fs-6';
            progressElement.className = 'progress-bar bg-secondary';
        }
    }

    // ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    var scoreInputs = [
        'korean_problems_solved', 'korean_problems_correct',
        'math_problems_solved', 'math_problems_correct'
    ];
    
    for (var i = 0; i < scoreInputs.length; i++) {
        var element = document.getElementById(scoreInputs[i]);
        element.addEventListener('input', updatePreviews);
        element.addEventListener('change', updatePreviews);
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì ìˆ˜ ê³„ì‚°
    updatePreviews();

    // ìœ íš¨ì„± ê²€ì‚¬
    function validateInput(input, max) {
        const value = parseInt(input.value);
        const maxValue = parseInt(input.getAttribute(max)) || 200;
        
        if (value > maxValue) {
            input.value = maxValue;
        }
        if (value < 0) {
            input.value = 0;
        }
    }

    // ë¬¸ì œ ìˆ˜ ìœ íš¨ì„± ê²€ì‚¬ (ë§ì€ ë¬¸ì œê°€ í‘¼ ë¬¸ì œë³´ë‹¤ ë§ì„ ìˆ˜ ì—†ìŒ)
    function validateCorrectAnswers() {
        const koreanSolved = parseInt(document.getElementById('korean_problems_solved').value) || 0;
        const koreanCorrect = document.getElementById('korean_problems_correct');
        const koreanCorrectValue = parseInt(koreanCorrect.value) || 0;
        
        if (koreanCorrectValue > koreanSolved) {
            koreanCorrect.value = koreanSolved;
        }
        
        const mathSolved = parseInt(document.getElementById('math_problems_solved').value) || 0;
        const mathCorrect = document.getElementById('math_problems_correct');
        const mathCorrectValue = parseInt(mathCorrect.value) || 0;
        
        if (mathCorrectValue > mathSolved) {
            mathCorrect.value = mathSolved;
        }
    }

    // ìœ íš¨ì„± ê²€ì‚¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    ['korean_problems_solved', 'korean_problems_correct', 'math_problems_solved', 'math_problems_correct'].forEach(id => {
        document.getElementById(id).addEventListener('input', validateCorrectAnswers);
    });

    // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ìƒˆ ì…ë ¥ ì‹œì—ë§Œ)
    {% if not record %}
    const dateInput = document.getElementById('date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    {% endif %}

    // ì´ˆê¸° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updatePreviews();
});
</script>
{% endblock %} 