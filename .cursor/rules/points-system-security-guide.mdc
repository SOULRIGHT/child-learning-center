# π›΅οΈ ν¬μΈνΈ μ‹μ¤ν… μ•μ •μ„± λ° λ³΄μ• κ°€μ΄λ“

## π¨ **ν•µμ‹¬ μ›μΉ™: ν¬μΈνΈ μ‹μ¤ν…μ€ μ λ€ μ‹¤ν¨ν•λ©΄ μ• λ¨**

### **μ λ€ κΈμ§€:**
- β **ν¬μΈνΈ κ³„μ‚° μ¤λ¥**
- β **λ°μ΄ν„°λ² μ΄μ¤ μ†μ‹¤**
- β **ν¬μΈνΈ λ°μ΄ν„° λ¶μΌμΉ**
- β **μ¤‘λ³µ κΈ°λ΅ μƒμ„±**

## π”’ **ν„μ¬ κµ¬ν„λ λ³΄μ• μ¥μΉλ“¤**

### **1. λ°μ΄ν„° κ²€μ¦ μ‹μ¤ν…**
```python
# κ°’ κ²€μ¦: μμ λ°©μ§€, λ²”μ„ κ²€μ¦ (0-200)
if any(points < 0 for points in [korean_points, math_points, ssen_points, reading_points]):
    flash('β ν¬μΈνΈλ” μμμΌ μ μ—†μµλ‹λ‹¤.', 'error')

if any(points > 200 for points in [korean_points, math_points, ssen_points, reading_points]):
    flash('β ν¬μΈνΈλ” 200μ μ„ μ΄κ³Όν•  μ μ—†μµλ‹λ‹¤.', 'error')
```

### **2. μ΄μ¤‘ κ³„μ‚° κ²€μ¦**
```python
# μ΄ ν¬μΈνΈ κ³„μ‚° (κ²€μ¦λ κ°’μΌλ΅)
total_points = korean_points + math_points + ssen_points + reading_points

# κ³„μ‚° κ²°κ³Ό κ²€μ¦ (μ΄μ¤‘ κ²€μ¦μΌλ΅ μ¤λ¥ λ°©μ§€)
expected_total = sum([korean_points, math_points, ssen_points, reading_points])
if total_points != expected_total:
    flash(f'β ν¬μΈνΈ κ³„μ‚° μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.', 'error')
```

### **3. μ™„λ²½ν• λ³€κ²½ μ΄λ ¥ μ¶”μ **
```python
# PointsHistory ν…μ΄λΈ”λ΅ λ¨λ“  λ³€κ²½μ‚¬ν•­ κΈ°λ΅
history_record = PointsHistory(
    old_korean_points=old_korean,
    new_korean_points=korean_points,
    change_type='update',
    changed_by=current_user.id,
    change_reason='μ›Ή UIλ¥Ό ν†µν• ν¬μΈνΈ μμ • (λ®μ–΄μ“°κΈ°)'
)
```

### **4. νΈλμ­μ… μ•μ „μ„±**
```python
try:
    # ν¬μΈνΈ μ €μ¥ λ΅μ§
    db.session.commit()
except Exception as e:
    db.session.rollback()  # μ¤λ¥ μ‹ μλ™ λ΅¤λ°±
    flash(f'β ν¬μΈνΈ μ €μ¥ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤: {str(e)}', 'error')
```

### **5. ν•λ£¨μ— ν• λ²λ§ μ…λ ¥ κ°€λ¥**
```python
# κΈ°μ΅΄ κΈ°λ΅μ΄ μλ”μ§€ ν™•μΈ (ν•λ£¨μ— ν•λ‚λ§ μ΅΄μ¬ν•΄μ•Ό ν•¨)
existing_record = DailyPoints.query.filter_by(
    child_id=child_id, 
    date=today
).first()

if existing_record:
    # π¨ κΈ°μ΅΄ κΈ°λ΅μ΄ μλ” κ²½μ°: λ®μ–΄μ“°κΈ° λ¨λ“
    # μ¤‘λ³µ κΈ°λ΅ μƒμ„± λ°©μ§€
```

## π”§ **ν¬μΈνΈ μ‹μ¤ν… κ΄€λ¦¬ λ…λ Ήμ–΄**

### **κ΄€λ¦¬μ μ „μ© κΈ°λ¥λ“¤:**
- **`/admin/points/integrity-check`**: ν¬μΈνΈ λ°μ΄ν„° λ¬΄κ²°μ„± κ²€μ¦
- **`/admin/points/duplicate-check`**: μ¤‘λ³µ κΈ°λ΅ κ²€μ‚¬ λ° μ •λ¦¬
- **`/admin/points/backup`**: ν¬μΈνΈ λ°μ΄ν„° μλ™ λ°±μ—…

### **κ¶ν• μ”κµ¬μ‚¬ν•­:**
```python
if not check_permission(required_roles=['κ°λ°μ', 'μ„Όν„°μ¥']):
    flash('β κ¶ν•μ΄ μ—†μµλ‹λ‹¤.', 'error')
    return redirect(url_for('dashboard'))
```

## π“ **ν¬μΈνΈ λ°μ΄ν„° κµ¬μ΅°**

### **DailyPoints ν…μ΄λΈ” (μΌμΌ ν¬μΈνΈ)**
```python
class DailyPoints(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    child_id = db.Column(db.Integer, db.ForeignKey('child.id'), nullable=False)
    date = db.Column(db.Date, nullable=False)
    
    # κ° κ³Όλ©λ³„ ν¬μΈνΈ (200 λλ” 100)
    korean_points = db.Column(db.Integer, default=0)
    math_points = db.Column(db.Integer, default=0)
    ssen_points = db.Column(db.Integer, default=0)
    reading_points = db.Column(db.Integer, default=0)
    
    # μ΄ ν¬μΈνΈ
    total_points = db.Column(db.Integer, default=0)
    
    # λ©”νƒ€λ°μ΄ν„°
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

### **PointsHistory ν…μ΄λΈ” (λ³€κ²½ μ΄λ ¥)**
```python
class PointsHistory(db.Model):
    """ν¬μΈνΈ λ³€κ²½ μ΄λ ¥ κΈ°λ΅"""
    id = db.Column(db.Integer, primary_key=True)
    child_id = db.Column(db.Integer, db.ForeignKey('child.id'), nullable=False)
    date = db.Column(db.Date, nullable=False)
    
    # λ³€κ²½ μ „/ν›„ ν¬μΈνΈ
    old_korean_points = db.Column(db.Integer, default=0)
    new_korean_points = db.Column(db.Integer, default=0)
    # ... λ“±λ“±
    
    # λ³€κ²½ μ •λ³΄
    change_type = db.Column(db.String(20), default='update')  # 'create', 'update', 'delete'
    changed_by = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    changed_at = db.Column(db.DateTime, default=datetime.utcnow)
    change_reason = db.Column(db.String(200))
```

## π€ **ν¬μΈνΈ μ…λ ¥ ν”λ΅μ°**

### **1. μƒ ν¬μΈνΈ μ…λ ¥**
```python
# 1. κΈ°μ΅΄ κΈ°λ΅ ν™•μΈ
existing_record = DailyPoints.query.filter_by(child_id=child_id, date=today).first()

# 2. μƒ κΈ°λ΅ μƒμ„±
if not existing_record:
    new_record = DailyPoints(...)
    db.session.add(new_record)
    db.session.commit()
    
    # 3. λ„μ  ν¬μΈνΈ μ—…λ°μ΄νΈ
    update_cumulative_points(child_id)
    
    # 4. μλ™ μ•λ¦Ό μƒμ„±
    create_automatic_notifications(child, new_record, is_update=False)
```

### **2. κΈ°μ΅΄ ν¬μΈνΈ μμ • (λ®μ–΄μ“°κΈ°)**
```python
# 1. κΈ°μ΅΄ κΈ°λ΅ ν™•μΈ
if existing_record:
    # 2. λ³€κ²½ μ΄λ ¥ κΈ°λ΅
    history_record = PointsHistory(...)
    db.session.add(history_record)
    
    # 3. κΈ°μ΅΄ κΈ°λ΅ μ—…λ°μ΄νΈ
    existing_record.korean_points = korean_points
    # ... λ“±λ“±
    db.session.commit()
    
    # 4. λ„μ  ν¬μΈνΈ μ—…λ°μ΄νΈ
    update_cumulative_points(child_id)
    
    # 5. μλ™ μ•λ¦Ό μƒμ„±
    create_automatic_notifications(child, existing_record, is_update=True)
```

## β οΈ **μ£Όμμ‚¬ν•­**

### **μ λ€ κΈμ§€:**
1. **λ™μ‹ μ…λ ¥**: κ°™μ€ μ•„λ™μ κ°™μ€ λ‚ μ§μ— μ—¬λ¬ λ² μ…λ ¥
2. **λ°μ΄ν„° μ†μ‹¤**: ν¬μΈνΈ μ €μ¥ μ¤‘ μ¤λ¥ λ°μƒ μ‹ λ°μ΄ν„° μ†μ‹¤
3. **κ³„μ‚° μ¤λ¥**: μ΄μ  κ³„μ‚°μ΄ λ¶€μ •ν™•ν• κ²½μ°
4. **κ¶ν• μ°ν**: κ¶ν•μ΄ μ—†λ” μ‚¬μ©μμ ν¬μΈνΈ μμ •

### **μ•μ „ν• λ°©λ²•:**
1. **ν•λ£¨μ— ν• λ²**: κ°™μ€ λ‚ μ§μ—λ” λ®μ–΄μ“°κΈ°λ§ κ°€λ¥
2. **μ΄μ¤‘ κ²€μ¦**: λ¨λ“  κ³„μ‚° κ²°κ³Όλ¥Ό μ΄μ¤‘μΌλ΅ κ²€μ¦
3. **μ™„λ²½ν• μ¶”μ **: λ¨λ“  λ³€κ²½μ‚¬ν•­μ„ PointsHistoryμ— κΈ°λ΅
4. **μλ™ λ°±μ—…**: μ •κΈ°μ μΈ ν¬μΈνΈ λ°μ΄ν„° λ°±μ—…

## π” **λ¬Έμ  ν•΄κ²°**

### **ν¬μΈνΈ κ³„μ‚° μ¤λ¥ λ°μƒ μ‹:**
1. **μ¦‰μ‹ μ¤‘λ‹¨**: μ¶”κ°€ μ…λ ¥ κΈμ§€
2. **λ°μ΄ν„° κ²€μ¦**: `validate_points_integrity()` μ‹¤ν–‰
3. **μ¤‘λ³µ κ²€μ‚¬**: `check_duplicate_daily_points()` μ‹¤ν–‰
4. **λ°±μ—… μƒμ„±**: `create_points_backup()` μ‹¤ν–‰

### **λ°μ΄ν„° λ¶μΌμΉ λ°κ²¬ μ‹:**
1. **μ›μΈ λ¶„μ„**: λ΅κ·Έ ν™•μΈ
2. **μλ™ μμ •**: λ¬΄κ²°μ„± κ²€μ¦ ν•¨μ μ‹¤ν–‰
3. **μλ™ ν™•μΈ**: κ²°κ³Ό κ²€μ¦
4. **μ¬μ‹μ‘**: μ‹μ¤ν… μ •μƒν™” ν™•μΈ

## π’΅ **λ¨λ²” μ‚¬λ΅€**

### **ν¬μΈνΈ μ…λ ¥ μ‹:**
1. **κ°’ κ²€μ¦**: μ…λ ¥κ°’ λ²”μ„ ν™•μΈ (0-200)
2. **κ³„μ‚° κ²€μ¦**: μ΄μ  μ΄μ¤‘ κ³„μ‚°μΌλ΅ κ²€μ¦
3. **μ΄λ ¥ κΈ°λ΅**: λ¨λ“  λ³€κ²½μ‚¬ν•­ κΈ°λ΅
4. **μλ™ μ—…λ°μ΄νΈ**: λ„μ  ν¬μΈνΈ μλ™ κ³„μ‚°

### **μ‹μ¤ν… κ΄€λ¦¬ μ‹:**
1. **μ •κΈ° κ²€μ¦**: μ£Όκ°„ λ¬΄κ²°μ„± κ²€μ¦
2. **λ°±μ—… μƒμ„±**: μΌμΌ μλ™ λ°±μ—…
3. **μ¤‘λ³µ κ²€μ‚¬**: μ›”κ°„ μ¤‘λ³µ κΈ°λ΅ κ²€μ‚¬
4. **μ„±λ¥ λ¨λ‹ν„°λ§**: ν¬μΈνΈ μ…λ ¥ μ†λ„ ν™•μΈ

---

> π¨ **μ¤‘μ”**: ν¬μΈνΈ μ‹μ¤ν…μ€ μ„Όν„° μ΄μμ ν•µμ‹¬μ…λ‹λ‹¤!
> μ λ€ μ‹¤ν¨ν•μ§€ μ•λ„λ΅ λ¨λ“  λ³΄μ• μ¥μΉλ¥Ό ν™μ©ν•μ„Έμ”.
description:
globs:
alwaysApply: true
---
